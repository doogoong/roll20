/* ë°°í¬í•˜ì‹  Kë‹˜ì˜ ì‚¬ë‹´ : */
/* ì›ë³¸ : ì–‘ì²œì¼ì—¼ë‹˜ì˜ smallchat_split.js https://github.com/kibkibe/roll20-api-scripts/tree/master/smallchat_split */
/* ì´ ì½”ë“œëŠ” ì–‘ì²œì¼ì—¼ë‹˜ì˜ ì½”ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤. ëŒ€ë¶€ë¶„ ì–‘ì²œì¼ì—¼ë‹˜ì´ ì‘ì—…í•˜ì…¨ê³  ì €ëŠ” ì¶œë ¥í˜•ì‹ì—ë§Œ ì¡°ê¸ˆ ì†ì„ ëŒ”ìŠµë‹ˆë‹¤.*/
/* ë°°í¬ë¥¼ í—ˆê°€í•´ ì£¼ì…”ì„œ ê°ì‚¬í•´ìš”! */

/* ë‘ê¶ ì‚¬ë‹´ */
/* ì¬ë°°í¬!! í•˜ì§€ ë§ì•„ì£¼ì„¸ìš”!!!!!!!! ì›ë³¸ì´ ìˆëŠ” ì½”ë“œë‹ˆê¹Œ!!!! */
/* ì½”ë“œ ì„¤ëª… íƒ€ë˜ https://twitter.com/DGcommu/status/1734903250447671354 */
/* í•´ë‹¹ ì½”ë“œëŠ” ë‹¤ì¸ìš© ì˜ˆì‹œì…ë‹ˆë‹¤. */
/* (smallchat_twitter.js) 220913 ì½”ë“œ ì‹œì‘ */



on('ready', function() {
    if (!state.smallchatlog) state.smallchatlog = [];
    if (!state.smallchatonair) state.smallchatonair = [];
});


on("chat:message", function(msg)
{
    if (msg.type == "api"){
     if (msg.content.indexOf("!@ ") === 0) {
        try {
        // option
        // íŠ¸ìœ— ë‚´ì—­ì„ ì €ì¥í•  í•¸ë“œì•„ì›ƒì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤.
        // ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ë ‰ì´ ê±¸ë ¤ìš”.ê¸°ì¡´ì— ìƒì„±ëœ í•¸ë“œì•„ì›ƒì˜ ì´ë¦„ì„ ë°”ê¿”ì£¼ì„¸ìš”! ex;(ì‚¬ë‹´log2) 
        var logname = '(ì‚¬ë‹´log)';
        // ì‹¤ì‹œê°„ íŠ¸ìœ—ì„ í‘œì‹œí•  ë³„ë„ì˜ í•¸ë“œì•„ì›ƒì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤.
        var onair_name = '(ì‹¤ì‹œê°„ íƒë¼)';
        // ì‹¤ì‹œê°„ íŠ¸ìœ—ìš© í•¸ë“œì•„ì›ƒì—ì„œ ìµœì‹ ìˆœìœ¼ë¡œ ëª‡ê°œê¹Œì§€ ì±„íŒ…ì„ í‘œì‹œí• ì§€ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
        var onair_lines = 12;
        // í•¸ë“œì•„ì›ƒì— í‘œì‹œí•˜ëŠ” ì±„íŒ…ì‹œê°ì˜ í‘œì¤€ì‹œê°„ëŒ€ë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ê¸°ë³¸ê°’ì€ KST(UTC+9)ì…ë‹ˆë‹¤.
        var timezone = 9;
  
        var ho = findObjs({ _type: 'handout', name:logname});
        var player = getObj('player',msg.playerid);
        var c=player.get('color');
        var player_id = '';
        
        let ss_setting = {
    	// option: ì±„íŒ…ì°½ì˜ ê¸€ì”¨í¬ê¸°ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
    	font_size: 14,
    	// option: ì±„íŒ…ì°½ì˜ ê¸€ì”¨ìƒ‰ì„ ì§€ì •í•©ë‹ˆë‹¤.
    	color: "rgb(255, 255, 255)",
    	// option: ì±„íŒ…ì°½ì˜ ìƒí•˜ì¢Œìš° ì—¬ë°±ì„ ì„¤ì •í•©ë‹ˆë‹¤. (ê¸€ì í¬ê¸°ì™€ ì¤„ ê°œìˆ˜ì— ì˜ì¡´í•˜ê¸° ë•Œë¬¸ì— ì •í™•í•˜ê²Œ ì…ë ¥í•œëŒ€ë¡œ ë°°ì¹˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ë„í•˜ëŠ” ë ˆì´ì•„ì›ƒì— ë§ì¶° ìœ„ì¹˜ë¥¼ ì¡°ê¸ˆì”© ì¡°ì •í•˜ëŠ”ë° ì‚¬ìš©í•˜ì„¸ìš”.)
    	margin: {top:40,right:30,bottom:20,left:30},
    	// option: ì±„íŒ…ë¡œê·¸ì— í”Œë ˆì´ì–´/PC ì¤‘ ì–´ëŠìª½ ì´ë¦„ì„ í‘œì‹œí• ì§€ ì§€ì •í•©ë‹ˆë‹¤. (true:í”Œë ˆì´ì–´/false:PC)
    	show_player_name: true,
    	// option: í•¸ë“œì•„ì›ƒì— ì €ì¥ë˜ëŠ” ì±„íŒ…ë¡œê·¸ì— í”Œë ˆì´ì–´ì˜ ê³ ìœ ìƒ‰ìƒì„ ì ìš©í• ì§€ì˜ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
    	// 0: ì‚¬ìš©ì•ˆí•¨ / 1: ì´ë¦„ë§Œ ì»¬ëŸ¬ / 2: ì±„íŒ…ê¹Œì§€ ì»¬ëŸ¬
    	use_personal_color: 1,
        }

        let ava_img= "";
        var split;
        
       if(player.get('_displayname')=="ë‘ê¶"){ //ìˆ˜ì •í•´ì£¼ì„¸ìš”!!!!!!!!!!!!!!ë¡¤ë°©GMì˜ë‹‰ë„¤ì„
            player='í­í’ì„ë¶€ë¥´ëŠ” ë§ë‘ê³°ë°œë°”ë‹¥ ëŒ€ì‘ì „'; //ìˆ˜ì •í•´ì£¼ì„¸ìš”! ë¡¤ë°©GMì´ í•´ë‹¹ ì‚¬ë‹´ì°½ì—ì„œ ì‚¬ìš©í•  ë‹‰ë„¤ì„
            player_id='DGcommu'; //ìˆ˜ì •í•´ì£¼ì„¸ìš”! ë¡¤ë°©GMì´ í•´ë‹¹ ì‚¬ë‹´ì°½ì—ì„œ ì‚¬ìš©í•  ì•„ì´ë””
            ava_img="https://i.imgur.com/xy0353q.png"; //ìˆ˜ì •í•´ì£¼ì„¸ìš”! ë¡¤ë°© GMì´ í•´ë‹¹ ì‚¬ë‹´ì°½ì—ì„œ ì´ìš©í•  í”„ì‚¬
        } 

/* ì•„ë˜ë¡œ í”Œë ˆì´ì–´ ì¸ì›ìˆ˜ì— ë§ê²Œ ì¡°ì ˆí•©ë‹ˆë‹¤. ì˜ˆì‹œë¡œ ì„¬íˆ´ë£¨ ë©¤ë²„ë¶„ë“¤ì„ ë¹Œë ¸ìŠµë‹ˆë‹¤...*/

        else if(player.get('_displayname')=="PL1ì˜ ë¡¤20ë‹‰ë„¤ì„"){
            player='ëŒì•„ì˜¨ PL1 ğŸ¤›ğŸ¤›'
            player_id='PL1'
            ava_img="";
        } 
        else if(player.get('_displayname')=="PL2ì˜ ë¡¤20ë‹‰ë„¤ì„"){
            player='ê³ ìš”í•œ the Monkeymagic'
            player_id='littlemonkeyman'
            ava_img="";
        } 
        else if(player.get('_displayname')=="PL3ì˜ ë¡¤20ë‹‰ë„¤ì„"){
            player='ì§ ì§ ë‚˜ëŠ” ğŸ‘“í•œì„œğŸ“±'
            player_id='Iloveglasses'
            ava_img="";
        } 
        else if(player.get('_displayname')=="PL4ì˜ ë¡¤20ë‹‰ë„¤ì„"){
            player='ğŸ€ë‹¤ë¯¸ë‹¤ë¯¸ë‹¤ë¯¸ğŸ€'
            player_id='DamiDamdance'
            ava_img="";
        } 
        
        
        

        if (ho.length > 0) {
            ho = ho[0];
        } else {
            ho = createObj('handout', {
                notes: ' ',
                inplayerjournals: 'all',
                name: logname
            });
        }
        

       let content_str = msg.content.substring(2); 
          //ì´ë¯¸ì§€ ë°°í¬:https://www.postype.com/@soboru830/post/17700785
       //ê°ì‚¬í•©ë‹ˆë‹¤!
       var res=content_str.match(/"í•´ê³¨"/);
        var res2=content_str.match(/"ê³ ì†Œ"/);
        var res3=content_str.match(/"ë¡œë”©ì¤‘"/);
        var res4=content_str.match(/"ì£½"/);
        var res5=content_str.match(/"ê°€ëŠ¥"/);
        var res6=content_str.match(/"ë¶ˆê°€ëŠ¥"/);
        var res7=content_str.match(/"ì‹¤íŒ¨"/);
        var res8=content_str.match(/"ëœë‹¤"/);
        var res9=content_str.match(/"ê°€ë³´ìê³ "/);
        var res10=content_str.match(/"ì´ì˜ìˆìŒ"/);
        var res11=content_str.match(/"!"/);
          
       if (res) {
           content_str = "[ ](https://i.imgur.com/k0WlrYB.png)"
       }
       
       else if (res2){
            content_str = "[ì´ë¯¸ì§€](https://imgur.com/pyz7FzD.png)"
       }
       else if (res3){
            content_str = "[ì´ë¯¸ì§€](https://imgur.com/1m7aOtV.png)"
       }
       else if (res4){
            content_str = "[ ](https://i.imgur.com/D6zhhK1.png)"
       }
       else if (res5){
            content_str = "[ì´ë¯¸ì§€](https://imgur.com/XD3ShZx.png)"
       }
       else if (res6){
            content_str = "[ì´ë¯¸ì§€](https://imgur.com/dol4qOK.png)"
       }
       else if (res7){
            content_str = "[ì´ë¯¸ì§€](https://imgur.com/AlBM3Tu.png)"
       }
       else if (res8){
            content_str = "[ì´ë¯¸ì§€](https://imgur.com/BuTFn0Y.png)"
       }
       else if (res9){
            content_str = "[ì´ë¯¸ì§€](https://imgur.com/bHNABFj.png)"
       }
       else if (res10){
            content_str = "[ì´ë¯¸ì§€](https://imgur.com/If2a4q8.png)"
       }
       else if (res11){
            content_str = "[ì´ë¯¸ì§€](https://imgur.com/eKj7x2p.png)"
       }
        
var res_img = content_str.match(/\[.+\]\(http.+\)/g);
let img_str = "";
if (res_img) {
for (var i=0;i<res_img.length;i++) {
 content_str = content_str.replace(res_img[i],"");
 img_str += "<div style ='border-radius:15px;overflow:hidden;text-align:center;border:1px solid #C4CFD6;margin-top:10px;margin-left:60px;margin-right:10px;'><img src ='" 
 + res_img[i].replace(/\[.+\]\(/g,"").replace(")","") + "'></div>";
}
}
        var d = new Date();
        var tz = d.getTime() + (d.getTimezoneOffset() * 60000) + (timezone * 3600000);
        d.setTime(tz);
        
        
        var final_notes = "<span style='color:#aaaaaa;font-size:7pt;'>"
					+ d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds()
					+ "</span>" + "<br>"
					+ (ss_setting.use_personal_color!=0?("<span style='color:"+c+";'>"):"") + "<b>"
					+ player + "</b>" + (ss_setting.use_personal_color===1?"</span>":"") + ": "
					+ (ss_setting.use_personal_color===2?"</span>":"") +content_str;
					
					
        
        var final_str = "<div width=70 style='border-radius:70%;overflow:hidden;valign:top;float:left;margin-right:10px'>"
                +"<img src='"+ava_img+"' width=50 height=50>" + "</div>"
                +"<div style='valign:top;'>"
                +"<span style='font-size:11pt'><b>"
                + player + "</b>" + "</span>"
                + "<span style='color:#848484;font-size:10pt;'>" + " @"+player_id+" Â· "
                + d.getFullYear() + "ë…„ " + (d.getMonth()+1) + "ì›” " + d.getDate() + "ì¼ " + "</span>" 
                + "<div style='float:right;valign:top;'><img src='https://i.imgur.com/MONxPND.png'></div>" + "<br><div><span style='font-size:11pt;'>"
                + content_str
                +"</span><br><div style='clear:both;'>"
                + img_str
                +"<div style='margin-left:50px;float:left;width: 21%;'><img src='https://i.imgur.com/3n6ZKwZ.png'></div>"
                +"<div style='float:left; width: 21%;'><img src='https://i.imgur.com/Wt5bQ5S.png'></div>"
                +"<div style='float:left; width: 21%;'><img src='https://i.imgur.com/6mnK0lU.png'></div>"
                +"<div style='float:left;width: 21%;'><img src='https://i.imgur.com/WuZtI1V.png'></div>"
                +"</div>"+"<div style='border-bottom:1px solid #ebeef0;clear:both;'></div>";

           var oa = findObjs({ _type: 'handout', name:onair_name});
            if (oa.length > 0) {
                oa = oa[0];
            } else {
                oa = createObj('handout', {
                    notes: ' ',
                    inplayerjournals: 'all',
                    name: onair_name
                });
            }
            oa.get('notes',function(text) {
                var final_split = (text.length > 0 && text != 'null' ? text.split("<br><i></i>") : []);
                final_split.push(final_str);
                if (final_split.length > onair_lines) {
                    final_split.splice(0,1);
                }
                state.smallchatonair.push(final_split.join("<br><i></i>"));
                if (state.smallchatonair.length > 0) {
                    oa.set({notes: state.smallchatonair[0]});
                    state.smallchatonair.splice(0,1);
                }
            });
        
        ho.get('notes',function(text) {
            state.smallchatlog.push((text.length > 0 && text != 'null' ? text : "") + "<br><i></i>" + final_notes);
            if (state.smallchatlog.length > 0) {
                ho.set({notes: state.smallchatlog[0]});
                state.smallchatlog.splice(0,1);
            }
        });
	} catch (error) {
        sendChat('error','/w GM '+error,null,{noarchive:true});
	}
    }
}
});
const findCharacterWithName = function(who) {
    let chat_cha = findObjs({ _type: 'character', name: who});
    return (chat_cha.length > 0) ? chat_cha[0] : null;
};
/* (smallchat_twitter.js) 220913 ì½”ë“œ ì¢…ë£Œ */
